# sample-sam-app

## ディレクトリ構成

- docker/
  - docker-compose.yaml　などDocker関連のリソースを配置（する想定）
- project/
  - SAMアプリの設定ファイルやテンプレート、Lambdaのソースコードなど
- README.md
  - 本テキスト

## リソース

### S3 Bucket

- SampleAppBucket
  - アプリで使用するS3バケット

### DynamoDB Table

- MessageTable
  - AddMessageFunction 関数が書き込む先のテーブル
- MemberTable
  - UpdateMemberFileFunction 関数がデータを受け取るテーブル

### Lambda Function

- HelloWorldFunction
  - `sam init` コマンドの実行時に生成されたデフォルトのLambda関数
  - Auto generated by `sam init` command.
- SimpleResponseFunction
  - 数値を受け取り、文字列を返すLambda関数
  - Receive a number and returns a string.
- AddMessageFunction
  - JSON形式のペイロードを受け取り、1件のアイテムを Message というDynamoDBテーブルに追加するLambda関数
  - Receive JSON payload and put one item into 'Message' table.
- UpdateMemberFileFunction
  - 他のAWSサービスと連携するLambda関数
  - Lambda functions to work with other AWS services.
- UpdateBookFileFunction
  - 他のAWSサービスと連携するLambda関数。ただしDynamoDBテーブルはこのSAMアプリのものではなく、別のアプリなどが作成したものを使う
  - Lambda functions to work with other AWS services(DynamoDB table already exists).

## LocalStackへのデプロイ

1. Book という DynamoDB を事前に作成
2. 1の結果 DynamoDB Streams のARNを確認
3. 2のARNを samconfigm.toml の local.global.parameters の `parameter_overrides` に含まれる `BookTableStreamArn` にセット
4. `sam build` または `samlocal build` でビルド
5. `samlocal deploy` でLocalStackにデプロイ

### Book テーブルの作成と DynamoDB Streams ARNの確認（手順1〜2）

`UpdateBookFileFunction` は `Book` テーブルが存在することが前提ですので、事前に作成しておく必要があります

```bash
# create-table の結果から LatestStreamArn を確認し samconfig.toml の parameter_overrides の BookTableStreamArn 値としてコピー
awslocal dynamodb create-table \
  --table-name Book \
  --attribute-definitions '[{"AttributeName":"seq","AttributeType":"N"}]' \
  --key-schema '{"AttributeName":"seq","KeyType":"HASH"}' \
  --provisioned-throughput '{"ReadCapacityUnits": 5,"WriteCapacityUnits": 5}' \
  --stream-specification '{"StreamEnabled": true,"StreamViewType": "NEW_IMAGE"}'
  
# (補足) ARNを確認するのはこちらでも可
awslocal dynamodb describe-table --table-name Book

# DynamoDB Stream が有効になっているかの確認
awslocal dynamodbstreams describe-stream --stream-arn [any-stream-arn]
```

### SAMアプリのビルドとデプロイ(手順４〜5)

```bash
# ビルド時の sam コマンドは samlocal コマンドでも可
sam build --config-env local --use-contaienr

# デプロイは samlocal
samlocal deploy --config-env local --guided
```

## Lambdaの実行

- `awslocal` コマンドは `aws --profile xxxxx --endpoint-url http://localhost:4566` のように、パラメータ付きの `aws` コマンドでも可
- `lambda invoke` でLambdaを実行する前に `lambda list-functions` コマンドでLambdaの状況を確認

### HelloWorldFunction

- HTTPステータスコード200とメッセージを返すだけの関数です

```bash
# 関数が作成されているか確認
awslocal lambda list-functions
awslocal lambda get-function --function-name "sample-sam-app-HelloWorldFunction-93a343b8"

# 関数を実行してレスポンスを確認
awslocal lambda invoke --function-name "sample-sam-app-HelloWorldFunction-93a343b8" /tmp/response-helloworld.json
```

### SimpleResponseFunction

- 実行時にペイロードで渡した数値に対応するHTTPステータスコードとメッセージを返す関数です
- REST APIとして、GETメソッドで呼び出される想定です

```bash
# 関数が作成されているか確認
awslocal lambda list-functions
awslocal lambda get-function --function-name "sample-sam-app-SimpleResponseFunction-96533490"

# REST API ID を確認
awslocal apigateway get-rest-apis

# cURLのGETパラメータで number を指定して呼び出す
curl "http://localhost:4566/restapis/<REST-API-ID>/simple_response/_user_request_/simple_response?number=3"
```

### AddMessageFunction

- 実行時に渡したペイロードに応じて、1件の項目を Message というDynamoDBテーブルに追加する関数です

```bash
# 関数が作成されているか確認
awslocal lambda list-functions
awslocal lambda get-function --function-name "sample-sam-app-SimpleDynamodbFunction-cdd357d1"

# 適当なペイロードを与えて関数を実行
awslocal lambda invoke \
  --function-name "sample-sam-app-local-AddMessageFunction-01e7712a" \
  --payload $(echo '{"sender":"Taro","receiver":"Jiro","message":"Hello, world!!"}' | base64) \
  /tmp/response-dynamodb.json
```

### UpdateMemberFileFunction

- Member というDynamoDBテーブルに項目が追加されたことをトリガーに、その内容に応じたデータをS3上のCSVファイルに追加する関数です

```bash
# put-item で Member にデータを投入
awslocal dynamodb put-item \
  --table-name Member \
  --item '{"seq":{"N":"1"},"name":{"S":"Taro"},"age":{"N":"30"},"sex":{"S":"MALE"}}'
  
# データができているか、できていたらその中身が期待通りか確認
awslocal dynamodb scan --table-name Member
awslocal s3 ls s3://sample-app-bucket
awslocal s3 cp s3://sample-app-bucket/members.csv ~/Downloads/members-copy.csv
cat ~/Downloads/members-copy.csv
```

### UpdateBookFileFunction

- Book という **既存のDynamoDBテーブル** に項目が追加されたことをトリガーに、その内容に応じたデータをS3上のCSVファイルに追記する関数です

```bash
# put-item で Book にデータを投入
awslocal dynamodb put-item \
  --table-name Book \
  --item '{"seq":{"N":"1"},"title":{"S":"書籍のタイトル"},"price":{"N":"3740"},"publisher":{"S":"出版社名"}}'
  
# データができているか、できていたらその中身が期待通りか確認
awslocal dynamodb scan --table-name Book
awslocal s3 ls s3://sample-app-bucket
awslocal s3 cp s3://sample-app-bucket/books.csv ~/Downloads/books-copy.csv
cat ~/Downloads/books-copy.csv
```