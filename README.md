# sample-sam-app

## Resource

### S3 Bucket

- SampleAppBucket
  - アプリで使用するS3バケット

### DynamoDB Table

- MessageTable
  - AddMessageFunction 関数が書き込む先のテーブル
- MemberTable
  - UpdateMemberFileFunction 関数がデータを受け取るテーブル

### Lambda Function

- HelloWorldFunction
  - `sam init` コマンドの実行時に生成されたデフォルトのLambda関数
  - Auto generated by `sam init` command.
- SimpleResponseFunction
  - 数値を受け取り、文字列を返すLambda関数
  - Receive a number and returns a string.
- AddMessageFunction
  - JSON形式のペイロードを受け取り、1件のアイテムを Message というDynamoDBテーブルに追加するLambda関数
  - Receive JSON payload and put one item into 'Message' table.
- UpdateMemberFileFunction
  - 他のAWSサービスと連携するLambda関数
  - Lambda functions to work with other AWS services.
- UpdateBookFileFunction
  - 他のAWSサービスと連携するLambda関数。ただしDynamoDBテーブルはこのSAMアプリのものではなく、別のアプリなどが作成したものを使う
  - Lambda functions to work with other AWS services(DynamoDB table already exists).

## Deploy LocalStack

`sam` command can be replaced by `samlocal` command.

```bash
sam build
samlocal deploy --guided
```

## Execution

- `awslocal` command can be replaced by `aws --profile xxxxx --endpoint-url http://localhost:4566`. 
- Check target function name by `lambda list-functions` before execute `lambda invoke`.

### HelloWorldFunction

- HTTPステータスコード200とメッセージを返すだけの関数です
- Lambda will response HTTP status code 200 and message.

```bash
# 関数が作成されているか確認
awslocal lambda list-functions
awslocal lambda get-function --function-name "sample-sam-app-HelloWorldFunction-93a343b8"

# 関数を実行してレスポンスを確認
awslocal lambda invoke --function-name "sample-sam-app-HelloWorldFunction-93a343b8" /tmp/response-helloworld.json
```

### SimpleResponseFunction

- 実行時にペイロードで渡した数値に対応するHTTPステータスコードとメッセージを返す関数です
- Lambda will response some message and HTTP status code according to the number given by payload at request.

```bash
# 関数が作成されているか確認
awslocal lambda list-functions
awslocal lambda get-function --function-name "sample-sam-app-SimpleResponseFunction-96533490"

# 適当なペイロードを与えて関数を実行
awslocal lambda invoke \
  --function-name "sample-sam-app-SimpleResponseFunction-96533490" \
  --payload $(echo '{"number":1}' | base64) \
  /tmp/response-simpleresponse.json
```

### AddMessageFunction

- 実行時に渡したペイロードに応じて、1件の項目を Message というDynamoDBテーブルに追加する関数です
- Lambda will put one item into DynamoDB table named 'Message'.

```bash
# 関数が作成されているか確認
awslocal lambda list-functions
awslocal lambda get-function --function-name "sample-sam-app-SimpleDynamodbFunction-cdd357d1"

# 適当なペイロードを与えて関数を実行
awslocal lambda invoke \
  --function-name "sample-sam-app-local-AddMessageFunction-01e7712a" \
  --payload $(echo '{"sender":"Taro","receiver":"Jiro","message":"Hello, world!!"}' | base64) \
  /tmp/response-dynamodb.json
```

### UpdateMemberFileFunction

- Member というDynamoDBテーブルに項目が追加されたことをトリガーに、その内容に応じたデータをS3上のCSVファイルに追加する関数です
- When put one item into DynamoDB table named 'Member', Lambda will get that item and write to CSV file on S3.

```bash
# put-item で Member にデータを投入
awslocal dynamodb put-item \
  --table-name Member \
  --item '{"seq":{"N":"1"},"name":{"S":"Taro"},"age":{"N":"30"},"sex":{"S":"MALE"}}'
  
# データができているか、できていたらその中身が期待通りか確認
awslocal dynamodb scan --table-name Member
awslocal s3 ls s3://sample-app-bucket
awslocal s3 cp s3://sample-app-bucket/members.csv ~/Downloads/members-copy.csv
cat ~/Downloads/members-copy.csv
```

### UpdateBookFileFunction

- Book という **既存のDynamoDBテーブル** に項目が追加されたことをトリガーに、その内容に応じたデータをS3上のCSVファイルに追記する関数です
- When put one item into DynamoDB table named 'Book', Lambda will get that item and write to CSV file on S3.

```bash
# create-table の結果から LatestStreamArn を確認し samconfig.toml の parameter_overrides の BookTableStreamArn 値としてコピー
awslocal dynamodb create-table \
  --table-name Book \
  --attribute-definitions '[{"AttributeName":"seq","AttributeType":"N"}]' \
  --key-schema '{"AttributeName":"seq","KeyType":"HASH"}' \
  --provisioned-throughput '{"ReadCapacityUnits": 5,"WriteCapacityUnits": 5}' \
  --stream-specification '{"StreamEnabled": true,"StreamViewType": "NEW_IMAGE"}'
  
# (補足) ARNを確認するのはこちらでも可
awslocal dynamodb describe-table --table-name Book

# DynamoDB Stream が有効になっているかの確認
awslocal dynamodbstreams describe-stream --stream-arn [any-stream-arn]

# put-item で Book にデータを投入
awslocal dynamodb put-item \
  --table-name Book \
  --item '{"seq":{"N":"1"},"title":{"S":"書籍のタイトル"},"price":{"N":"3740"},"publisher":{"S":"出版社名"}}'
  
# データができているか、できていたらその中身が期待通りか確認
awslocal dynamodb scan --table-name Book
awslocal s3 ls s3://sample-app-bucket
awslocal s3 cp s3://sample-app-bucket/books.csv ~/Downloads/books-copy.csv
cat ~/Downloads/books-copy.csv
```